<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Questions Management - Admin Dashboard</title>
    <link rel="icon" href="images/logo.png" type="image/png">
    <link rel="shortcut icon" href="images/logo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #1f1c2c, #928dab);
            min-height: 100vh;
            background-attachment: fixed;
            background-size: cover;
            color: #f1f1f1;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: rgba(0, 0, 0, 0.7) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .navbar-nav .nav-link {
            color: #fff !important;
            transition: color 0.3s ease;
        }
        .navbar-nav .nav-link:hover {
            color: #ffc107 !important;
        }
        .container {
            margin-top: 2rem;
        }
        .table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            backdrop-filter: blur(8px);
        }
        .table th,
        .table td {
            vertical-align: middle;
        }
        .table-dark th {
            background-color: rgba(0, 0, 0, 0.6);
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        .form-control,
        .form-select {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .form-control::placeholder {
            color: #ccc;
        }
        /* Custom select dropdown styling for dark mode */
        .form-select, .form-select option {
            background-color: #23243a !important;
            color: #f1f1f1 !important;
        }
        .form-select:focus {
            border-color: #6a82fb;
            box-shadow: 0 0 0 0.2rem rgba(106,130,251,0.15);
        }
        .form-select option:checked, .form-select option:hover {
            background-color: #6a82fb !important;
            color: #fff !important;
        }
        /* For better cross-browser support */
        select:focus > option:checked {
            background: #6a82fb !important;
            color: #fff !important;
        }
        /* Badge improvements for clarity */
        .question-type-badge-solid { border-radius:8px; padding:4px 8px; display:inline-flex; align-items:center; gap:6px; white-space: nowrap; width:auto; }
        .icon-btn { width:36px; height:36px; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; background:#ffffff; border:1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .btn {
            border-radius: 12px;
        }
        .btn-primary {
            background-color: #6a82fb;
            border-color: #6a82fb;
        }
        .btn-warning {
            background-color: #ffb347;
            border-color: #ffb347;
            color: #000;
        }
        .btn-danger {
            background-color: #ff5e62;
            border-color: #ff5e62;
        }
        .btn-info {
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: #fff;
        }
        .btn-info:hover {
            color: #fff;
            background-color: #138496;
            border-color: #117a8b;
        }
        .btn-outline-light:hover {
            background-color: #fff;
            color: #000;
        }
        .table {
            font-size: 0.9rem;
        }
        .table td, .table th {
            padding: 0.5rem;
            white-space: normal;
        }
        .btn-sm {
            padding: 0.25rem;
            font-size: 0.8rem;
            min-width: 80px;
            margin: 1px 0;
        }
        .container {
            max-width: 98%;
            margin: 0 auto;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(12px);
            color: #fff;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 255, 255, 0.1);
        }
        .question-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(8px);
        }
        .question-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .timestamp-badge {
            background-color: #17a2b8;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.8rem;
        }
        .question-card {
            background: rgba(20,22,40,0.32);
            border: 1px solid rgba(255,255,255,0.42);
            border-radius: 18px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.14), inset 0 0 0 1px rgba(255,255,255,0.12);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
            transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease;
        }
        .question-card:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(0,0,0,0.18); }
        .question-card .q-image-wrap {
            border-radius:12px;
            overflow:hidden;
            border:1px solid rgba(255,255,255,0.35);
            background:#111;
            height: 120px; /* smaller fixed image area height */
        }
        .question-card .q-image {
            width:100%;
            height:100%; /* fill fixed area */
            object-fit:cover; /* crop to fit without distortion */
            display:block;
        }
        .question-card .q-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.65);
        }
        .question-card .q-image-placeholder i { font-size: 32px; }
        @media (max-width: 575.98px) {
            .question-card { padding: 12px 12px; border-radius: 16px; }
            .question-card .q-title { font-size: 1rem; }
            .question-card .q-image-wrap { height: 100px; }
        }
    </style>
</head>
<body>
    <div class="container mt-3">
        <a href="index.html" class="btn btn-outline-light mb-3" style="border-radius: 30px; font-weight: 600;">
            ‚Üê Back to Dashboard
        </a>
    </div>

    <div class="container mt-4">
        <h4 class="mb-3">Interactive Questions Management</h4>
        
        <!-- Course Selection -->
        <div class="row mb-4">
            <div class="col-md-4">
                <label for="playlistSelect" class="form-label">Select Playlist:</label>
                <select class="form-select" id="playlistSelect">
                    <option value="">-- Select Playlist --</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="courseSelect" class="form-label">Select Course:</label>
                <select class="form-select" id="courseSelect">
                    <option value="">-- Select Course --</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-primary w-100" id="loadQuestionsBtn">
                    <i class="fas fa-search"></i> Load Questions
                </button>
            </div>
        </div>

        <!-- Search and Add Button -->
        <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
            <input type="text" id="questionSearchInput" class="form-control" placeholder="Search questions..." style="max-width: 300px;" />
            <button class="btn btn-outline-light" id="clearQuestionSearch" type="button" style="display:none;">Clear</button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                <i class="fas fa-plus"></i> Add Question
            </button>
        </div>

        <!-- Questions List -->
        <div id="questionsContainer">
            <div class="text-center py-5">
                <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                <p class="text-muted">Select a course to view interactive questions</p>
            </div>
        </div>
    </div>

    <!-- Add/Edit Question Modal -->
    <div class="modal fade" id="addQuestionModal" tabindex="-1" aria-labelledby="addQuestionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addQuestionModalLabel">Add New Question</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="questionForm">
                        <input type="hidden" id="questionId" name="questionId">
                        
                        <!-- Course Selection -->
                        <div class="mb-3">
                            <label for="modalCourseSelect" class="form-label">Course *</label>
                            <select class="form-select" id="modalCourseSelect" required>
                                <option value="">-- Select Course --</option>
                            </select>
                        </div>

                        <!-- Question Type -->
                        <div class="mb-3">
                            <label for="questionType" class="form-label">Question Type *</label>
                            <select class="form-select" id="questionType" required>
                                <option value="multiple_choice">Multiple Choice</option>
                                <option value="text">Text Answer</option>
                                <option value="true_false">True/False</option>
                            </select>
                        </div>

                        <!-- Timestamp -->
                        <div class="mb-3">
                            <label for="timestamp" class="form-label">Question Timestamp (seconds) *</label>
                            <input type="number" class="form-control" id="timestamp" min="0" required>
                            <div class="mt-1">
                                <small class="fw-semibold text-info" style="background:rgba(143,211,244,0.18); padding:4px 10px; border-radius:7px; display:inline-block;">Example: 30 = appears 30 seconds into the video</small>
                            </div>
                        </div>

                        <!-- Question Text -->
                        <div class="mb-3">
                            <label for="questionText" class="form-label">Question Text *</label>
                            <textarea class="form-control" id="questionText" rows="3" required></textarea>
                        </div>

                        <!-- Question Image (optional) -->
                        <div class="mb-3">
                            <label for="questionImage" class="form-label">Question Image (optional)</label>
                            <input type="file" class="form-control" id="questionImage" name="image" accept="image/*">
                            <div class="form-text">Max 5MB. Supported: JPG, PNG, GIF, WEBP</div>
                            <div id="imagePreviewWrapper" class="mt-2" style="display:none;">
                                <img id="imagePreview" src="" alt="Question Image" style="max-width: 100%; max-height: 180px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2);" />
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" value="true" id="removeImage">
                                    <label class="form-check-label" for="removeImage">
                                        Remove current image
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Multiple Choice Options -->
                        <div id="multipleChoiceSection" class="mb-3">
                            <label class="form-label">Options *</label>
                            <div id="optionsContainer">
                                <div class="input-group mb-2">
                                    <span class="input-group-text">A</span>
                                    <input type="text" class="form-control option-input" name="options[]" data-index="0" required>
                                    <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" data-mcq-radio value="0">
                                    </div>
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">B</span>
                                    <input type="text" class="form-control option-input" name="options[]" data-index="1" required>
                                    <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" data-mcq-radio value="1">
                                    </div>
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">C</span>
                                    <input type="text" class="form-control option-input" name="options[]" data-index="2" required>
                                    <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" data-mcq-radio value="2">
                                    </div>
                                </div>
                                <div class="input-group mb-2">
                                    <span class="input-group-text">D</span>
                                    <input type="text" class="form-control option-input" name="options[]" data-index="3" required>
                                    <div class="input-group-text">
                                        <input class="form-check-input mt-0" type="radio" data-mcq-radio value="3">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Text Answer -->
                        <div id="textAnswerSection" class="mb-3" style="display:none;">
                            <label for="textAnswer" class="form-label">Correct Answer *</label>
                            <input type="text" class="form-control" id="textAnswer">
                        </div>

                        <!-- True/False Answer -->
                        <div id="trueFalseSection" class="mb-3" style="display:none;">
                            <label class="form-label">Correct Answer *</label>
                            <div class="d-flex">
                                <div class="form-check me-4">
                                    <input class="form-check-input" type="radio" name="trueFalseAnswer" id="answerFalse" value="0" required>
                                    <label class="form-check-label" for="answerFalse">False</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="trueFalseAnswer" id="answerTrue" value="1" required>
                                    <label class="form-check-label" for="answerTrue">True</label>
                                </div>
                            </div>
                        </div>

                        <!-- Explanation -->
                        <div class="mb-3">
                            <label for="explanation" class="form-label">Explanation *</label>
                            <textarea class="form-control" id="explanation" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="questionForm" class="btn btn-primary">Save Question</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'https://api.hamdan.help/api';
        // const API_BASE_URL = 'http://localhost:3000/api';
        const API_ORIGIN = new URL(API_BASE_URL).origin;

        // Helper to build absolute URL for images from relative paths like 'uploads/...'
        function buildImageUrl(p) {
            if (!p) return '';
            if (/^https?:\/\//i.test(p)) return p;
            const clean = p.replace(/^\/+/, '');
            return `${API_ORIGIN}/${clean}`;
        }
        let currentQuestions = [];
        let currentCourseId = null;
        let playlistsData = [];

        // Initialize page
        $(document).ready(function() {
            loadCourses();
            setupEventListeners();
            // Reset form and clear questionId when opening Add Question modal
            $('#addQuestionModal').on('show.bs.modal', function (e) {
                // Only reset if not editing (i.e., if the button was clicked, not editQuestion)
                if (!$('#questionId').val()) {
                    // Complete form reset
                    $('#questionForm')[0].reset();
                    $('#questionId').val('');
                    
                    // Clear all input fields
                    $('#questionText').val('');
                    $('#explanation').val('');
                    $('#timestamp').val('');
                    $('#questionImage').val('');
                    $('#removeImage').prop('checked', false);
                    $('#imagePreview').attr('src', '');
                    $('#imagePreviewWrapper').hide();
                    
                    // Clear all option inputs
                    $('.option-input').val('');
                    
                    // Uncheck all radio buttons
                    $('input[type="radio"]').prop('checked', false);
                    
                    // Set default type to multiple_choice and trigger change
                    $('#questionType').val('multiple_choice').trigger('change');
                    
                    // Remove any validation errors
                    $('.is-invalid, .is-valid').removeClass('is-invalid is-valid');
                    
                    // Reset modal title
                    $('#addQuestionModalLabel').text('Add New Question');
                }
            });
        });

        // Load playlists then populate playlist & course dropdowns (reusing function name for compatibility)
        async function loadCourses() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showAlert('Please login first', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/playlists`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    showAlert('Session expired, please login again', 'warning');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to fetch playlists');
                }
                
                const data = await response.json();
                
                if (data.success && Array.isArray(data.data)) {
                    playlistsData = data.data || [];

                    const playlistSelect = $('#playlistSelect');
                    const courseSelect = $('#courseSelect');
                    const modalCourseSelect = $('#modalCourseSelect');

                    // Restore last selections if available
                    const lastPlaylistId = localStorage.getItem('iq_lastPlaylistId') || '';
                    const lastCourseId = localStorage.getItem('iq_lastCourseId') || '';

                    // Populate playlists
                    playlistSelect.empty().append('<option value="">-- Select Playlist --</option>');
                    playlistsData.forEach(pl => {
                        const opt = `<option value="${pl.id}">${pl.title}</option>`;
                        playlistSelect.append(opt);
                    });
                    if (lastPlaylistId && playlistsData.some(p => String(p.id) === String(lastPlaylistId))) {
                        playlistSelect.val(lastPlaylistId);
                    }

                    // Populate courses for selected playlist
                    function populateCoursesFor(playlistId) {
                        courseSelect.empty().append('<option value="">-- Select Course --</option>');
                        const selected = playlistsData.find(p => String(p.id) === String(playlistId));
                        const courses = selected?.courses || [];
                        courses.forEach(c => {
                            courseSelect.append(`<option value="${c.id}">${c.title}</option>`);
                        });
                        if (lastCourseId && courses.some(c => String(c.id) === String(lastCourseId))) {
                            courseSelect.val(lastCourseId);
                        }
                    }

                    const effectivePlaylistId = playlistSelect.val() || (playlistsData[0]?.id || '');
                    if (effectivePlaylistId) {
                        playlistSelect.val(String(effectivePlaylistId));
                        populateCoursesFor(effectivePlaylistId);
                    } else {
                        courseSelect.empty().append('<option value="">-- Select Course --</option>');
                    }

                    // Populate modal courses grouped by playlist
                    modalCourseSelect.empty().append('<option value="">-- Select Course --</option>');
                    playlistsData.forEach(pl => {
                        const optgroup = $(`<optgroup label="${pl.title}"></optgroup>`);
                        (pl.courses || []).forEach(c => {
                            optgroup.append(`<option value="${c.id}">${c.title}</option>`);
                        });
                        modalCourseSelect.append(optgroup);
                    });

                    // Auto-load questions if we have a preselected course
                    const chosenCourseId = $('#courseSelect').val();
                    if (chosenCourseId) {
                        loadQuestions();
                    }
                }
            } catch (error) {
                console.error('Error loading courses:', error);
                showAlert('Error loading playlists/courses: ' + error.message, 'error');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Load questions button
            $('#loadQuestionsBtn').click(loadQuestions);

            // Playlist change -> repopulate courses
            $('#playlistSelect').on('change', function() {
                const pid = $(this).val();
                localStorage.setItem('iq_lastPlaylistId', pid || '');
                // Repopulate courses for selected playlist
                const courseSelect = $('#courseSelect');
                courseSelect.empty().append('<option value="">-- Select Course --</option>');
                const selected = playlistsData.find(p => String(p.id) === String(pid));
                const courses = selected?.courses || [];
                courses.forEach(c => {
                    courseSelect.append(`<option value="${c.id}">${c.title}</option>`);
                });
                // Clear last course selection on playlist change
                localStorage.removeItem('iq_lastCourseId');
            });

            // When course changes, remember it
            $('#courseSelect').on('change', function(){
                const cid = $(this).val();
                localStorage.setItem('iq_lastCourseId', cid || '');
            });
            
            // Question type change
            $('#questionType').change(function() {
                const type = $(this).val();
                
                // Hide all answer sections first
                $('#multipleChoiceSection, #textAnswerSection, #trueFalseSection').hide();
                
                // Remove all name and required attributes
                $('input[type="radio"][data-mcq-radio]').removeAttr('name required');
                $('#textAnswer').removeAttr('name required');
                $('input[name="trueFalseAnswer"]').removeAttr('name required');
                $('.option-input').removeAttr('required');
                
                if (type === 'multiple_choice') {
                    $('#multipleChoiceSection').show();
                    // Set name and required for MCQ radios
                    $('input[type="radio"][data-mcq-radio]').attr('name', 'correctAnswer').attr('required', true);
                    // Add required to all option inputs
                    $('.option-input').attr('required', true);
                } else if (type === 'text') {
                    $('#textAnswerSection').show();
                    // Set name and required for text answer
                    $('#textAnswer').attr('name', 'textAnswer').attr('required', true);
                } else if (type === 'true_false') {
                    $('#trueFalseSection').show();
                    // Set name and required for true/false radios
                    $('#answerTrue, #answerFalse').attr('name', 'trueFalseAnswer').attr('required', true);
                }
            });
            
            // Form submission
            $('#questionForm').submit(handleQuestionSubmit);
            
            // Search functionality (initially hidden)
            $('#questionSearchInput').on('input', filterQuestions);
            $('#clearQuestionSearch').click(function() {
                $('#questionSearchInput').val('');
                filterQuestions();
                $(this).hide();
            });
            // Hide search bar initially
            $('#questionSearchInput').closest('.mb-3').hide();
            $('#clearQuestionSearch').hide();
            // Hide search bar when course changes
            $('#courseSelect').on('change', function() {
                $('#questionSearchInput').val('');
                $('#questionSearchInput').closest('.mb-3').hide();
                $('#clearQuestionSearch').hide();
            });
        }

        // Load questions for selected course
        async function loadQuestions() {
            const courseId = $('#courseSelect').val();
            if (!courseId) {
                showAlert('Please select a course first', 'warning');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showAlert('Please login first', 'warning');
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/courses/${courseId}/questions`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.status === 401) {
                    showAlert('Session expired, please login again', 'warning');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Failed to fetch questions');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    currentQuestions = data.data || [];
                    currentCourseId = courseId;
                    displayQuestions(currentQuestions);
                    // Show search bar if there are questions
                    if (currentQuestions.length > 0) {
                        $('#questionSearchInput').closest('.mb-3').show();
                    } else {
                        $('#questionSearchInput').closest('.mb-3').hide();
                    }
                } else {
                    showAlert('No questions found for this course', 'info');
                    displayQuestions([]);
                    $('#questionSearchInput').closest('.mb-3').hide();
                }
            } catch (error) {
                console.error('Error loading questions:', error);
                showAlert('Error loading questions: ' + error.message, 'error');
                $('#questionSearchInput').closest('.mb-3').hide();
            }
        }

        // Display questions in the container
        function displayQuestions(questions) {
            const container = $('#questionsContainer');
            
            if (questions.length === 0) {
                container.html(`
                    <div class="text-center py-5">
                        <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No questions found for this course</p>
                    </div>
                `);
                return;
            }

            let html = '<div class="row questions-row">';
            questions.forEach((question, index) => {
                // Type badge with icon and solid color
                let typeBadge;
                if (question.type === 'multiple_choice') {
                    typeBadge = `<span class="badge question-type-badge-solid" style="background-color:#1976d2 !important;"><i class='fas fa-list-ul'></i> MCQ</span>`;
                } else if (question.type === 'true_false') {
                    typeBadge = `<span class="badge question-type-badge-solid" style="background-color:#388e3c !important;"><i class='fas fa-check-circle'></i> T/F</span>`;
                } else {
                    typeBadge = `<span class="badge question-type-badge-solid" style="background-color:#fbc02d !important;"><i class='fas fa-font'></i> Text</span>`;
                }
                // Timestamp badge with clock icon
                const timeBadge = `<span class="badge badge-soft"><i class='far fa-clock'></i> ${formatTime(question.timestamp)}</span>`;
                // Info badge (number of options or text answer)
                let infoBadge;
                if (question.type === 'multiple_choice') {
                    infoBadge = `<span class="badge badge-soft info">${question.options && question.options.length ? question.options.length : 0} options</span>`;
                } else if (question.type === 'true_false') {
                    infoBadge = `<span class="badge badge-soft success">True/False</span>`;
                } else {
                    infoBadge = `<span class="badge badge-soft warning">Text Answer</span>`;
                }
                // Image src prefer imagePath
                const imgSrc = question.imagePath ? buildImageUrl(question.imagePath) : (question.imageUrl || '');
                const imgHtml = imgSrc
                  ? `<div class="q-image-wrap"><img class="q-image" src="${imgSrc}" alt="Question image"/></div>`
                  : `<div class=\"q-image-wrap\"><div class=\"q-image-placeholder\"><i class=\"fas fa-image\"></i></div></div>`;
                html += `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="question-card">
                            <div class="q-header mb-1">
                                ${typeBadge}
                                ${timeBadge}
                            </div>
                            <div class="q-body flex-grow-1">
                                ${imgHtml}
                                <div class="q-title">${question.question}</div>
                            </div>
                            <div class="q-footer mt-1">
                                ${infoBadge}
                                <div class="d-flex gap-2">
                                    <button class="icon-btn edit" title="Edit" onclick="editQuestion('${question.id}')"><i class="fas fa-edit"></i></button>
                                    <button class="icon-btn delete" title="Delete" onclick="deleteQuestion('${question.id}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.html(html);
        }

        // Format timestamp to MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Filter questions based on search input (client-side only)
        function filterQuestions() {
            const searchTerm = $('#questionSearchInput').val().toLowerCase();
            const clearBtn = $('#clearQuestionSearch');
            
            if (searchTerm) {
                clearBtn.show();
                const filtered = currentQuestions.filter(q => 
                    q.question.toLowerCase().includes(searchTerm) ||
                    (q.explanation && q.explanation.toLowerCase().includes(searchTerm))
                );
                displayQuestions(filtered);
            } else {
                clearBtn.hide();
                displayQuestions(currentQuestions);
            }
        }

        // Handle question form submission
        async function handleQuestionSubmit(e) {
            e.preventDefault();
            
            const token = localStorage.getItem('token');
            if (!token) {
                showAlert('Please login first', 'warning');
                return;
            }

            const courseId = $('#modalCourseSelect').val();
            const type = $('#questionType').val();
            const timestamp = parseInt($('#timestamp').val());
            const questionText = $('#questionText').val();
            const explanation = $('#explanation').val();
            const file = $('#questionImage')[0]?.files?.[0] || null;

            const formData = new FormData();
            formData.append('type', type);
            formData.append('timestamp', String(timestamp));
            formData.append('question', questionText);
            formData.append('explanation', explanation);
            // Validate and collect data based on question type
            if (type === 'multiple_choice') {
                const options = [];
                $('.option-input').each(function() {
                    options.push($(this).val());
                });
                formData.append('options', JSON.stringify(options));
                formData.append('correctAnswer', String(parseInt($('input[name="correctAnswer"]:checked').val())));
            } else if (type === 'text') {
                formData.append('answer', $('#textAnswer').val());
            } else if (type === 'true_false') {
                // For true/false questions, we use the predefined options ['False', 'True']
                // and the correctAnswer is either 0 (False) or 1 (True)
                formData.append('correctAnswer', String(parseInt($('input[name="trueFalseAnswer"]:checked').val())));
            }

            // Image handling
            const isEdit = Boolean($('#questionId').val());
            if (file) {
                formData.append('image', file);
            } else if (isEdit && $('#removeImage').is(':checked')) {
                formData.append('removeImage', 'true');
            }

            try {
                const questionId = $('#questionId').val();
                const url = questionId 
                    ? `${API_BASE_URL}/questions/${questionId}`
                    : `${API_BASE_URL}/courses/${courseId}/questions`;
                const method = questionId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.status === 401) {
                    showAlert('Session expired, please login again', 'warning');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to save question');
                }

                const data = await response.json();
                if (data.success) {
                    showAlert('Question saved successfully!', 'success');
                    $('#addQuestionModal').modal('hide');
                    loadQuestions();
                } else {
                    throw new Error(data.message || 'Failed to save question');
                }
            } catch (error) {
                console.error('Error saving question:', error);
                showAlert('Error saving question: ' + error.message, 'error');
            }
        }

        // Edit question
        function editQuestion(questionId) {
            const question = currentQuestions.find(q => q.id === questionId);
            if (!question) return;

            $('#questionId').val(question.id);
            $('#modalCourseSelect').val(question.courseId);
            
            // Set the question type directly, including true/false
            $('#questionType').val(question.type);
            $('#questionType').trigger('change');
            
            $('#timestamp').val(question.timestamp);
            $('#questionText').val(question.question);
            $('#explanation').val(question.explanation);
            // Reset image input
            $('#questionImage').val('');
            $('#removeImage').prop('checked', false);
            // Prefer imagePath for preview
            const editImgSrc = question.imagePath ? buildImageUrl(question.imagePath) : (question.imageUrl || '');
            if (editImgSrc) {
                $('#imagePreview').attr('src', editImgSrc);
                $('#imagePreviewWrapper').show();
            } else {
                $('#imagePreview').attr('src', '');
                $('#imagePreviewWrapper').hide();
            }

            // Hide all sections first
            $('#multipleChoiceSection, #textAnswerSection, #trueFalseSection').hide();
            
            // Remove all name and required attributes
            $('input[type="radio"][data-mcq-radio]').removeAttr('name required');
            $('#textAnswer').removeAttr('name required');
            $('input[name="trueFalseAnswer"]').removeAttr('name required');
            $('.option-input').removeAttr('required');
            
            if (question.type === 'multiple_choice') {
                $('#multipleChoiceSection').show();
                question.options.forEach((option, index) => {
                    $(`.option-input[data-index="${index}"]`).val(option);
                });
                $(`input[type="radio"][data-mcq-radio][value="${question.correctAnswer}"]`).prop('checked', true);
                // Set name and required for MCQ radios
                $('input[type="radio"][data-mcq-radio]').attr('name', 'correctAnswer').attr('required', true);
                // Add required to all option inputs
                $('.option-input').attr('required', true);
            } else if (question.type === 'text') {
                $('#textAnswerSection').show();
                $('#textAnswer').val(question.answer);
                // Set name and required for text answer
                $('#textAnswer').attr('name', 'textAnswer').attr('required', true);
            } else if (question.type === 'true_false') {
                $('#trueFalseSection').show();
                // Set correct answer for true/false
                $(`input[name="trueFalseAnswer"][value="${question.correctAnswer}"]`).prop('checked', true);
                // Set name and required for true/false radios
                $('input[name="trueFalseAnswer"]').attr('required', true);
            }

            $('#addQuestionModalLabel').text('Edit Question');
            $('#addQuestionModal').modal('show');
        }

        // Delete question
        async function deleteQuestion(questionId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This action cannot be undone!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            showAlert('Please login first', 'warning');
                            return;
                        }

                        const response = await fetch(`${API_BASE_URL}/questions/${questionId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.status === 401) {
                            showAlert('Session expired, please login again', 'warning');
                            return;
                        }

                        if (!response.ok) {
                            throw new Error('Failed to delete question');
                        }

                        const data = await response.json();
                        if (data.success) {
                            showAlert('Question deleted successfully!', 'success');
                            loadQuestions();
                        } else {
                            throw new Error(data.message || 'Failed to delete question');
                        }
                    } catch (error) {
                        console.error('Error deleting question:', error);
                        showAlert('Error deleting question: ' + error.message, 'error');
                    }
                }
            });
        }

        // Show alert using SweetAlert2
        function showAlert(message, type = 'info') {
            Swal.fire({
                title: type === 'error' ? 'Error' : type === 'success' ? 'Success' : type === 'warning' ? 'Warning' : 'Info',
                text: message,
                icon: type,
                confirmButtonColor: '#6a82fb'
            });
        }
    </script>
</body>
</html> 