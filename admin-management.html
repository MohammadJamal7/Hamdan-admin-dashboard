<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Management</title>
  <link rel="icon" href="images/logo.png" type="image/png">
  <link rel="shortcut icon" href="images/logo.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      background: linear-gradient(135deg, #1f1c2c, #928dab);
      min-height: 100vh;
      background-attachment: fixed;
      background-size: cover;
      color: #f1f1f1;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .container { margin-top: 2rem; }
    .admin-list { margin-bottom: 40px; }
    .admin-card { background: #393e46; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .permissions-list label { margin-right: 15px; }
    .form-check { display: inline-block; margin-right: 10px; }
    .super-admin-badge { background: #ffc107; color: #232946; font-weight: bold; border-radius: 6px; padding: 2px 8px; margin-left: 10px; }
  </style>
</head>
<body>
  <div class="container mt-3">
    <a href="index.html" class="btn btn-outline-light mb-3" style="border-radius: 30px; font-weight: 600;">
      ‚Üê Back to Dashboard
    </a>
  </div>
  <div class="container mt-4">
    <h2 class="mb-4">Admin Management</h2>
    <div class="mb-4">
      <div class="input-group">
        <input type="text" id="searchInput" class="form-control" placeholder="Search admin by email or username">
        <button class="btn btn-primary" id="searchBtn">Search</button>
      </div>
    </div>
    <div id="adminList" class="admin-list"></div>
    <hr/>
    <h4>Create New Admin</h4>
    <form id="createAdminForm" class="mb-5">
      <div class="row g-2">
        <div class="col-md-2"><input type="text" class="form-control" id="newName" placeholder="Name" required></div>
        <div class="col-md-2"><input type="email" class="form-control" id="newEmail" placeholder="Email" required></div>
        <div class="col-md-2"><input type="text" class="form-control" id="newUsername" placeholder="Username" required></div>
        <div class="col-md-2"><input type="password" class="form-control" id="newPassword" placeholder="Password" required></div>
        <div class="col-md-2"><input type="text" class="form-control" id="newPhone" placeholder="Phone" required></div>
      </div>
      <div class="mt-3 permissions-list">
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_admins"> Manage Admins</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_students"> Manage Students</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_courses"> Manage Courses</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_playlists"> Manage Playlists</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="send_notifications"> Send Notifications</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_settings"> Manage Settings</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_notifications"> Manage Notifications</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_support_links"> Manage Support Links</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_privacy_policy"> Manage Privacy Policy</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_questions"> Interactive Questions Expert</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="send_messages"> Send Messages</label>
        <label><input type="checkbox" class="form-check-input" name="permissions" value="manage_universities"> Manage Universities</label>
      </div>
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="isSuperAdmin" value="true">
        <label class="form-check-label" for="isSuperAdmin">Super Admin</label>
      </div>
      <button type="submit" class="btn btn-success mt-3">Create Admin</button>
      <div id="createAdminMsg" class="mt-2"></div>
    </form>
  </div>
  <script>
    // Toast notification function
    function showToast(message, type = 'success') {
      let toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = 1100;
        document.body.appendChild(toastContainer);
      }
      const toastId = `toast-${Date.now()}`;
      const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `;
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      const toastEl = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
    }
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));
    if (!token) {
      window.location.href = 'login.html';
    }
    const API = 'https://api.hamdan.help/api';
    const adminListDiv = document.getElementById('adminList');
    const createAdminForm = document.getElementById('createAdminForm');
    const createAdminMsg = document.getElementById('createAdminMsg');
    // Permissions list
    const ALL_PERMISSIONS = [
      'manage_admins', 'manage_students', 'manage_courses', 'manage_playlists', 'send_notifications', 'manage_settings', 'manage_notifications', 'manage_support_links', 'manage_privacy_policy', 'manage_questions', 'send_messages', 'manage_universities'
    ];
    let allAdmins = [];
    // Load all admins and render them
    async function loadAllAdmins() {
      adminListDiv.innerHTML = '<div>Loading admins...</div>';
      try {
        const res = await fetch(`${API}/students?adminsOnly=true`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (res.ok && data.success && Array.isArray(data.data)) {
          // Only show users with isAdmin true
          allAdmins = data.data.filter(admin => admin.isAdmin);
          renderAdmins(allAdmins);
        } else {
          adminListDiv.innerHTML = '<div class="text-danger">No admins found.</div>';
        }
      } catch (err) {
        adminListDiv.innerHTML = '<div class="text-danger">Error loading admins.</div>';
      }
    }

    // On page load, show all admins
    loadAllAdmins();

    // Search admin by email or username (client-side only)
    document.getElementById('searchBtn').onclick = function() {
      const query = document.getElementById('searchInput').value.trim().toLowerCase();
      if (!query) {
        renderAdmins(allAdmins);
        return;
      }
      const filtered = allAdmins.filter(admin =>
        (admin.email && admin.email.toLowerCase().includes(query)) ||
        (admin.username && admin.username.toLowerCase().includes(query)) ||
        (admin.name && admin.name.toLowerCase().includes(query))
      );
      renderAdmins(filtered);
    }
    // Live search as user types
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value.trim().toLowerCase();
      if (!query) {
        renderAdmins(allAdmins);
        return;
      }
      const filtered = allAdmins.filter(admin =>
        (admin.email && admin.email.toLowerCase().includes(query)) ||
        (admin.username && admin.username.toLowerCase().includes(query)) ||
        (admin.name && admin.name.toLowerCase().includes(query))
      );
      renderAdmins(filtered);
    });
    // Remove Enter/Backspace/Delete search logic (now handled by input event)
    // Render admins (same as before)
    function renderAdmins(admins) {
      adminListDiv.innerHTML = '';
      admins.forEach(admin => {
        const card = document.createElement('div');
        card.className = 'admin-card';
        card.innerHTML = `
          <div class="d-flex align-items-center justify-content-between">
            <div><strong>${admin.name} (${admin.email})</strong> <span class="badge bg-secondary ms-2">${admin.username}</span>
              ${admin.isSuperAdmin ? '<span class="super-admin-badge">Super Admin</span>' : ''}
            </div>
            <div>
              <button class="btn btn-sm btn-outline-light" onclick="showEdit('${admin.id}')">Edit</button>
              <button class="btn btn-sm btn-danger ms-2" onclick="deleteAdmin('${admin.id}', '${admin.name}')">Delete</button>
            </div>
          </div>
          <div id="edit-${admin.id}" class="mt-3" style="display:none;"></div>
        `;
        adminListDiv.appendChild(card);
      });
    }
    // Show edit form
    window.showEdit = function(adminId) {
      console.log('Edit clicked', adminId); // Debug log
      const editDiv = document.getElementById(`edit-${adminId}`);
      if (!editDiv) {
        console.error('Edit div not found for', adminId);
        return;
      }
      // Fetch admin details from the new /admins/:id endpoint
      fetch(`${API}/admins/${adminId}`, { headers: { 'Authorization': `Bearer ${token}` } })
        .then(res => {
          if (!res.ok) {
            if (res.status === 403 || res.status === 401) {
              throw new Error('You do not have permission to edit admins.');
            }
            throw new Error('Failed to fetch admin details');
          }
          return res.json();
        })
        .then(data => {
          if (data.success) {
            const a = data.data;
            editDiv.innerHTML = `
              <form onsubmit="return false;" id="editForm-${a._id || a.id}">
                <div class="permissions-list mb-2">
                  ${ALL_PERMISSIONS.map(perm => `
                    <label><input type="checkbox" class="form-check-input" name="permissions" value="${perm}" ${a.permissions.includes(perm) ? 'checked' : ''}> ${perm.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label>
                  `).join('')}
                </div>
                <div class="form-check mb-2">
                  <input class="form-check-input" type="checkbox" id="superAdminEdit-${a._id || a.id}" ${a.isSuperAdmin ? 'checked' : ''}>
                  <label class="form-check-label" for="superAdminEdit-${a._id || a.id}">Super Admin</label>
                </div>
                <button type="button" class="btn btn-primary btn-sm" onclick="saveEdit('${a._id || a.id}')">Save</button>
                <button type="button" class="btn btn-secondary btn-sm ms-2" onclick="hideEdit('${a._id || a.id}')">Cancel</button>
                <div id="editMsg-${a._id || a.id}" class="mt-2"></div>
              </form>
            `;
            editDiv.style.display = '';
          } else {
            editDiv.innerHTML = `<div class='text-danger'>Failed to load admin details: ${data.message || 'Unknown error'}</div>`;
            editDiv.style.display = '';
          }
        })
        .catch(err => {
          console.error('Error in showEdit:', err);
          editDiv.innerHTML = `<div class='text-danger'>Error loading admin details: ${err.message}</div>`;
          editDiv.style.display = '';
        });
    }
    window.hideEdit = function(adminId) {
      document.getElementById(`edit-${adminId}`).style.display = 'none';
    }
    window.saveEdit = function(adminId) {
      const form = document.getElementById(`editForm-${adminId}`);
      const perms = Array.from(form.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);
      const isSuper = form.querySelector(`#superAdminEdit-${adminId}`).checked;
      fetch(`${API}/students/${adminId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ permissions: perms, isSuperAdmin: isSuper })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById(`editMsg-${adminId}`).textContent = data.success ? 'Saved!' : (data.message || 'Failed');
        if (data.success) setTimeout(() => { document.getElementById(`editMsg-${adminId}`).textContent = ''; }, 2000);
      });
    }
    // Super Admin logic for edit form
    window.addEventListener('click', function(e) {
      if (e.target && e.target.classList.contains('form-check-input') && e.target.id.startsWith('superAdminEdit-')) {
        const form = e.target.closest('form');
        const permCheckboxes = form.querySelectorAll('input[name="permissions"]');
        if (e.target.checked) {
          permCheckboxes.forEach(cb => { cb.checked = true; cb.disabled = true; cb.parentElement.style.opacity = 0.5; });
        } else {
          permCheckboxes.forEach(cb => { cb.checked = false; cb.disabled = false; cb.parentElement.style.opacity = 1; });
        }
      }
    });
    // Create new admin
    createAdminForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('newName').value.trim();
      const email = document.getElementById('newEmail').value.trim();
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value.trim();
      const phone = document.getElementById('newPhone').value.trim();
      const permissions = Array.from(document.querySelectorAll('input[name="permissions"]:checked')).map(cb => cb.value);
      const isSuperAdmin = document.getElementById('isSuperAdmin').checked;
      createAdminMsg.textContent = 'Creating...';
      try {
        const res = await fetch(`${API}/register-admin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ name, email, username, password, phone, permissions, isSuperAdmin })
        });
        const data = await res.json();
        if (res.status === 201 && data.success) {
          createAdminMsg.textContent = 'Admin created!';
          fetchAdmins();
          createAdminForm.reset();
          setTimeout(() => { createAdminMsg.textContent = ''; }, 2000);
        } else {
          let errorMsg = data.message || 'Failed to create admin.';
          if (data.error) errorMsg += `\n${data.error}`;
          createAdminMsg.textContent = errorMsg;
        }
      } catch (err) {
        createAdminMsg.textContent = err.message;
      }
    });
    // Super Admin disables all permissions checkboxes
    document.getElementById('isSuperAdmin').addEventListener('change', function() {
      const permCheckboxes = document.querySelectorAll('input[name="permissions"]');
      if (this.checked) {
        permCheckboxes.forEach(cb => { cb.checked = true; cb.disabled = true; cb.parentElement.style.opacity = 0.5; });
      } else {
        permCheckboxes.forEach(cb => { cb.checked = false; cb.disabled = false; cb.parentElement.style.opacity = 1; });
      }
    });
    // After creating a new admin, reload all admins
    function fetchAdmins() {
      loadAllAdmins();
    }
    // Delete admin function
    window.deleteAdmin = function(adminId, adminName) {
      Swal.fire({
        title: `Delete Admin`,
        text: `Are you sure you want to delete admin '${adminName}'? This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (!result.isConfirmed) return;
        fetch(`${API}/students/${adminId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('Admin deleted successfully!', 'success');
            loadAllAdmins();
          } else {
            showToast('Failed to delete admin: ' + (data.message || 'Unknown error'), 'danger');
          }
        })
        .catch(err => {
          showToast('Error deleting admin: ' + err.message, 'danger');
        });
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>